{% extends "base.html" %}

{% block content %}
<!-- Mobile Header -->
<div class="mobile-header">
    <h1><i class="fas fa-city"></i> Voice</h1>
    <div class="user-info">
        <span>ðŸ‘¤ {{ current_user.full_name }}</span>
        <span style="font-size: 0.8rem; opacity: 0.9;">(Administrator)</span>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="mobile-tabs">
    <a href="{{ url_for('admin_dashboard') }}" class="mobile-tab">Dashboard</a>
    <a href="{{ url_for('admin_issues') }}" class="mobile-tab">Issues</a>
    <a href="{{ url_for('admin_analytics') }}" class="mobile-tab">Analytics</a>
    <a href="{{ url_for('admin_users') }}" class="mobile-tab">Users</a>
    <a href="{{ url_for('admin_feedback') }}" class="mobile-tab active">Feedback</a>
    <a href="{{ url_for('profile') }}" class="mobile-tab">Profile</a>
    <a href="{{ url_for('logout') }}" class="mobile-tab">Logout</a>
</div>

<!-- Main Card -->
<div class="mobile-card">
    <h3><i class="fas fa-star"></i> User Feedback</h3>
    <p>View feedback from users on resolved issues.</p>
</div>

<!-- Feedback Statistics -->
<div class="mobile-card">
    <h5><i class="fas fa-chart-bar"></i> Feedback Statistics</h5>
    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h1 class="card-title">{{ feedbacks|length }}</h1>
                    <p class="card-text">Total Feedback</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h1 class="card-title">{{ "%.1f"|format(avg_rating) }}</h1>
                    <p class="card-text">Average Rating</p>
                    <div class="mt-2">
                        {% for i in range(5) %}
                            <i class="fas fa-star {% if i < avg_rating|int %}text-warning{% else %}text-light{% endif %}"></i>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    {% set completed_issues = issues_done_count %}
                    <h1 class="card-title">
                        {{ "%.0f"|format((feedbacks|length / completed_issues * 100) if completed_issues > 0 else 0) }}%
                    </h1>
                    <p class="card-text">Feedback Rate</p>
                    <small>of resolved issues</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rating Distribution -->
<div class="mobile-card">
    <h5><i class="fas fa-star-half-alt"></i> Rating Distribution</h5>
    <div class="row">
        {% for rating in range(5, 0, -1) %}
        <div class="col-md-12 mb-2">
            <div class="d-flex align-items-center">
                <div class="me-3" style="width: 80px;">
                    <strong>{{ rating }} Star{{ 's' if rating > 1 else '' }}</strong>
                </div>
                <div class="flex-grow-1">
                    <div class="progress" style="height: 25px;">
                        {% set percentage = (rating_counts[rating] / feedbacks|length * 100) if feedbacks|length > 0 else 0 %}
                        <div class="progress-bar
                            {% if rating >= 4 %}bg-success
                            {% elif rating == 3 %}bg-warning
                            {% else %}bg-danger{% endif %}"
                            role="progressbar"
                            style="width: {{ percentage|round(1) }}%;">
                            {{ rating_counts[rating] }} ({{ "%.1f"|format(percentage) }}%)
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Feedback List -->
<div class="mobile-card">
    <h5><i class="fas fa-list"></i> Recent Feedback</h5>

    {% if feedbacks %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Issue</th>
                    <th>Rating</th>
                    <th>Comment</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for feedback in feedbacks[:10] %}
                <tr>
                    <td>
                        <strong>{{ feedback.user.full_name }}</strong><br>
                        <small class="text-muted">@{{ feedback.user.username }}</small>
                    </td>
                    <td>
                        <strong>{{ feedback.issue.title[:30] }}{% if feedback.issue.title|length > 30 %}...{% endif %}</strong><br>
                        <small class="text-muted">{{ SERVICE_TYPES[feedback.issue.service_type].name }}</small>
                    </td>
                    <td>
                        <div class="star-rating-small">
                            {% for i in range(5) %}
                            <i class="fas fa-star {% if i < feedback.rating %}text-warning{% else %}text-muted{% endif %}"></i>
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        {% if feedback.comment %}
                        <p class="mb-0">{{ feedback.comment[:100] }}{% if feedback.comment|length > 100 %}...{% endif %}</p>
                        {% else %}
                        <span class="text-muted">No comment</span>
                        {% endif %}
                    </td>
                    <td>{{ feedback.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewFeedback('{{ feedback.id }}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1">Previous</a>
            </li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
                <a class="page-link" href="#">Next</a>
            </li>
        </ul>
    </nav>

    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No feedback received yet.
    </div>
    {% endif %}
</div>

<!-- Export Options -->
<div class="mobile-card">
    <h5><i class="fas fa-download"></i> Export Feedback</h5>
    <div class="row g-2">
        <div class="col-md-4">
            <button class="btn btn-outline-primary w-100" onclick="exportFeedback()">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-outline-primary w-100" onclick="printReport()">
                <i class="fas fa-print"></i> Print Report
            </button>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('admin_feedback') }}" class="btn btn-outline-info w-100">
                <i class="fas fa-sync-alt"></i> Refresh
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.star-rating-small i {
    font-size: 0.9rem;
    color: #ddd;
}

.star-rating-small i.text-warning {
    color: #ffc107;
}

.progress-bar {
    font-weight: 500;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function viewFeedback(feedbackId) {
    alert('Viewing feedback details for ID: ' + feedbackId);
    // In a real implementation, this would show a modal with full details
}

function exportFeedback() {
    alert('Exporting feedback data to Excel...');
    // In a real implementation, this would generate and download an Excel file
}

function printReport() {
    window.print();
}
</script>
{% endblock %}