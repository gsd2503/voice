{% extends "base.html" %}

{% block content %}
<!-- Mobile Header -->
<div class="mobile-header">
    <h1><i class="fas fa-city"></i> CivicCare</h1>
    <div class="user-info">
        <span>ðŸ‘¤ {{ current_user.full_name }}</span>
        <span style="font-size: 0.8rem; opacity: 0.9;">(Citizen)</span>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="mobile-tabs">
    <a href="{{ url_for('dashboard') }}" class="mobile-tab">Home</a>
    <a href="{{ url_for('report_issue') }}" class="mobile-tab">Report Issue</a>
    <a href="{{ url_for('my_issues') }}" class="mobile-tab">My Issues</a>
    <a href="{{ url_for('view_issues') }}" class="mobile-tab active">View Issues</a>
    <a href="{{ url_for('map_view') }}" class="mobile-tab">Map</a>
    <a href="{{ url_for('profile') }}" class="mobile-tab">Profile</a>
    <a href="{{ url_for('logout') }}" class="mobile-tab">Logout</a>
</div>

<!-- Main Card -->
<div class="mobile-card">
    <h3><i class="fas fa-list"></i> All Community Issues</h3>
    <p>Browse issues reported by all community members.</p>
</div>

<!-- Filters -->
<div class="mobile-card">
    <h5><i class="fas fa-filter"></i> Filter Issues</h5>
    <form method="GET" action="{{ url_for('view_issues') }}" class="row g-3">
        <div class="col-md-4">
            <label class="form-label">Service Type</label>
            <select class="form-control" name="service_type">
                <option value="all">All Types</option>
                {% for service_key, service_info in SERVICE_TYPES.items() %}
                <option value="{{ service_key }}" {% if request.args.get('service_type') == service_key %}selected{% endif %}>
                    {{ service_info.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Status</label>
            <select class="form-control" name="status">
                <option value="all">All Statuses</option>
                {% for status_key, status_info in ISSUE_STATUSES.items() %}
                <option value="{{ status_key }}" {% if request.args.get('status') == status_key %}selected{% endif %}>
                    {{ status_info.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Priority</label>
            <select class="form-control" name="priority">
                <option value="all">All Priorities</option>
                {% for priority_key, priority_info in PRIORITY_LEVELS.items() %}
                <option value="{{ priority_key }}" {% if request.args.get('priority') == priority_key %}selected{% endif %}>
                    {{ priority_info.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-8">
            <label class="form-label">Search Location</label>
            <input type="text" class="form-control" name="location"
                   placeholder="Enter area, street, or city"
                   value="{{ request.args.get('location', '') }}">
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100" style="margin-top: 32px;">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
    </form>
</div>

<!-- Issues List -->
<div class="mobile-card">
    <h5>Found {{ issues_with_counts|length }} issues</h5>

    {% if issues_with_counts %}
    <div class="list-group mt-3">
        {% for item in issues_with_counts %}
        {% set issue = item.issue %}
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h5 class="mb-1">{{ issue.title }}</h5>
                    <p class="mb-1 text-muted">
                        <i class="fas fa-map-marker-alt"></i> {{ issue.location }}
                        {% if issue.area %}<span class="ms-2"><i class="fas fa-building"></i> {{ issue.area }}</span>{% endif %}
                    </p>

                    <div class="mt-2">
                        <span class="badge {{ SERVICE_TYPES[issue.service_type].badge_class }}">
                            <i class="{{ SERVICE_TYPES[issue.service_type].icon_class }}"></i>
                            {{ SERVICE_TYPES[issue.service_type].name }}
                        </span>
                        <span class="badge {{ PRIORITY_LEVELS[issue.priority].badge_class }}">
                            {{ PRIORITY_LEVELS[issue.priority].name }}
                        </span>
                        <span class="badge {{ ISSUE_STATUSES[issue.status].badge_class }}">
                            {{ ISSUE_STATUSES[issue.status].name }}
                        </span>
                    </div>

                    <p class="mt-2 mb-1">{{ issue.description[:150] }}{% if issue.description|length > 150 %}...{% endif %}</p>

                    <div class="mt-2 text-muted small">
                        <i class="fas fa-user"></i> {{ issue.reporter.full_name if issue.reporter else 'Unknown' }}
                        <span class="mx-2">â€¢</span>
                        <i class="fas fa-calendar"></i> {{ issue.date.strftime('%Y-%m-%d') }}
                        <span class="mx-2">â€¢</span>
                        <i class="fas fa-lightbulb"></i> {{ item.solutions_count }} solutions
                    </div>
                </div>
                <div class="ms-3">
                    <a href="{{ url_for('view_solutions', issue_id=issue.id) }}" class="btn btn-primary">
                        <i class="fas fa-lightbulb"></i> View Solutions
                    </a>
                </div>
            </div>

            {% if issue.media_paths %}
            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-paperclip"></i>
                    {% set media_list = issue.media_paths|from_json %}
                    {{ media_list|length }} attachment(s)
                </small>
            </div>
            {% endif %}

            {% if issue.latitude and issue.longitude %}
            <div class="mt-2">
                <a href="{{ url_for('map_view') }}?focus={{ issue.id }}" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-map-marker-alt"></i> View on Map
                </a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle"></i> No issues found matching your criteria.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Add filter for location search
document.addEventListener('DOMContentLoaded', function() {
    // Add click handler for map buttons
    document.querySelectorAll('.btn-outline-info').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            if (href && href.includes('focus=')) {
                const issueId = href.split('focus=')[1];
                if (issueId) {
                    localStorage.setItem('focusIssue', issueId);
                }
            }
        });
    });
});
</script>

<style>
.list-group-item {
    border-left: none;
    border-right: none;
    padding: 1rem 0;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}

.badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    margin-right: 0.25rem;
}
</style>
{% endblock %}