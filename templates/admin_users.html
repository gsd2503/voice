{% extends "base.html" %}

{% block content %}
<!-- Mobile Header -->
<div class="mobile-header">
    <h1><i class="fas fa-city"></i> Voice</h1>
    <div class="user-info">
        <span>ðŸ‘¤ {{ current_user.full_name }}</span>
        <span style="font-size: 0.8rem; opacity: 0.9;">(Administrator)</span>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="mobile-tabs">
    <a href="{{ url_for('admin_dashboard') }}" class="mobile-tab">Dashboard</a>
    <a href="{{ url_for('admin_issues') }}" class="mobile-tab">Issues</a>
    <a href="{{ url_for('admin_analytics') }}" class="mobile-tab">Analytics</a>
    <a href="{{ url_for('admin_users') }}" class="mobile-tab active">Users</a>
    <a href="{{ url_for('profile') }}" class="mobile-tab">Profile</a>
    <a href="{{ url_for('logout') }}" class="mobile-tab">Logout</a>
</div>

<!-- Main Card -->
<div class="mobile-card">
    <h3><i class="fas fa-users"></i> Users Management</h3>
    <p>Manage system users and their permissions.</p>
</div>

<!-- User Actions -->
<div class="mobile-card">
    <h5><i class="fas fa-cogs"></i> User Actions</h5>
    <div class="row g-2">
        <div class="col-md-4">
            <button class="btn btn-primary w-100" onclick="addNewUser()">
                <i class="fas fa-user-plus"></i> Add New User
            </button>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary w-100">
                <i class="fas fa-sync-alt"></i> Refresh Users
            </a>
        </div>
        <div class="col-md-4">
            <button class="btn btn-success w-100" onclick="exportUsers()">
                <i class="fas fa-download"></i> Export Users
            </button>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="mobile-card">
    <h5><i class="fas fa-search"></i> Search & Filter</h5>
    <div class="row g-3">
        <div class="col-md-6">
            <input type="text" class="form-control" placeholder="Search by name, username, or email"
                   id="searchUsers" onkeyup="filterUsers()">
        </div>
        <div class="col-md-3">
            <select class="form-control" id="filterRole" onchange="filterUsers()">
                <option value="all">All Roles</option>
                {% for role_key, role_name in USER_ROLES.items() %}
                <option value="{{ role_key }}">{{ role_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-control" id="filterStatus" onchange="filterUsers()">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="mobile-card">
    <h5>Total Users: {{ users|length }}</h5>

    {% if users %}
    <div class="table-responsive mt-3">
        <table class="table table-hover" id="usersTable">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Contact</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="user-row"
                    data-name="{{ user.full_name.lower() }} {{ user.username.lower() }} {{ user.email.lower() }}"
                    data-role="{{ user.role }}"
                    data-status="{{ 'active' if user.is_active else 'inactive' }}">
                    <td>
                        <div class="d-flex align-items-center">
                            <div style="font-size: 1.5rem; margin-right: 10px;">
                                {% if user.role == 'admin' %}ðŸ‘‘{% else %}ðŸ‘¤{% endif %}
                            </div>
                            <div>
                                <strong>{{ user.full_name }}</strong><br>
                                <small class="text-muted">@{{ user.username }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        {{ user.email }}<br>
                        {% if user.phone %}
                        <small class="text-muted">{{ user.phone }}</small>
                        {% else %}
                        <small class="text-muted">No phone</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge
                            {% if user.role == 'admin' %}bg-danger
                            {% elif user.role == 'moderator' %}bg-warning
                            {% else %}bg-primary{% endif %}">
                            {{ USER_ROLES[user.role] }}
                        </span>
                    </td>
                    <td>
                        {% if user.is_active %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle"></i> Active
                        </span>
                        {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-times-circle"></i> Inactive
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ user.created_at.strftime('%Y-%m-%d') }}<br>
                        <small class="text-muted">{{ user.created_at.strftime('%H:%M') }}</small>
                    </td>
                    <td>
                        {% if user.last_login %}
                        {{ user.last_login.strftime('%Y-%m-%d') }}<br>
                        <small class="text-muted">{{ user.last_login.strftime('%H:%M') }}</small>
                        {% else %}
                        <span class="text-muted">Never</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewUser('{{ user.id }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="editUser('{{ user.id }}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-cog"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="changeRole('{{ user.id }}', 'user')">
                                        <i class="fas fa-user text-primary"></i> Set as User
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="changeRole('{{ user.id }}', 'moderator')">
                                        <i class="fas fa-user-shield text-warning"></i> Set as Moderator
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="changeRole('{{ user.id }}', 'admin')">
                                        <i class="fas fa-crown text-danger"></i> Set as Admin
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                {% if user.is_active %}
                                <li>
                                    <a class="dropdown-item text-warning" href="#" onclick="toggleStatus('{{ user.id }}', false)">
                                        <i class="fas fa-ban"></i> Deactivate
                                    </a>
                                </li>
                                {% else %}
                                <li>
                                    <a class="dropdown-item text-success" href="#" onclick="toggleStatus('{{ user.id }}', true)">
                                        <i class="fas fa-check"></i> Activate
                                    </a>
                                </li>
                                {% endif %}
                                <li>
                                    <a class="dropdown-item text-danger" href="#" onclick="deleteUser('{{ user.id }}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Statistics -->
    <div class="row mt-3">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5>{{ users|selectattr('role', 'equalto', 'user')|list|length }}</h5>
                    <p class="card-text">Citizens</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5>{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</h5>
                    <p class="card-text">Admins</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5>{{ users|selectattr('is_active', 'equalto', true)|list|length }}</h5>
                    <p class="card-text">Active</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    {% set new_users = users|selectattr('created_at', '>=', date_30_days_ago)|list|length %}
                    <h5>{{ new_users }}</h5>
                    <p class="card-text">New (30d)</p>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle"></i> No users found.
    </div>
    {% endif %}
</div>

<!-- User Management Tips -->
<div class="mobile-card">
    <h5><i class="fas fa-lightbulb"></i> User Management Tips</h5>
    <div class="row">
        <div class="col-md-6">
            <div class="alert alert-info">
                <h6><i class="fas fa-user-shield"></i> Role Permissions</h6>
                <ul class="mb-0">
                    <li><strong>Admin:</strong> Full system access</li>
                    <li><strong>Moderator:</strong> Can manage issues only</li>
                    <li><strong>User:</strong> Can report and view issues</li>
                </ul>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-warning">
                <h6><i class="fas fa-exclamation-triangle"></i> Important Notes</h6>
                <ul class="mb-0">
                    <li>Always verify before changing roles</li>
                    <li>Deactivated users cannot log in</li>
                    <li>Deleted users cannot be recovered</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filter users based on search and filters
function filterUsers() {
    const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
    const roleFilter = document.getElementById('filterRole').value;
    const statusFilter = document.getElementById('filterStatus').value;

    document.querySelectorAll('.user-row').forEach(row => {
        const name = row.dataset.name;
        const role = row.dataset.role;
        const status = row.dataset.status;

        const matchesSearch = name.includes(searchTerm);
        const matchesRole = roleFilter === 'all' || role === roleFilter;
        const matchesStatus = statusFilter === 'all' || status === statusFilter;

        row.style.display = (matchesSearch && matchesRole && matchesStatus) ? '' : 'none';
    });
}

// Add new user
function addNewUser() {
    alert('Add new user functionality would open a modal form here.');
    // In a real implementation, this would show a modal with a user creation form
}

// Export users
function exportUsers() {
    alert('Exporting users to CSV...');
    // In a real implementation, this would trigger a CSV download
}

// View user details
function viewUser(userId) {
    alert('Viewing user details for ID: ' + userId);
    // window.location.href = '/admin/users/' + userId;
}

// Edit user
function editUser(userId) {
    alert('Editing user with ID: ' + userId);
    // This would open an edit modal or redirect to edit page
}

// Change user role
function changeRole(userId, newRole) {
    if (confirm('Change user role to ' + newRole + '?')) {
        alert('Changing role for user ' + userId + ' to ' + newRole);
        // In a real implementation, this would send an AJAX request
    }
}

// Toggle user status
function toggleStatus(userId, activate) {
    const action = activate ? 'activate' : 'deactivate';
    if (confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} this user?`)) {
        alert(`${action.charAt(0).toUpperCase() + action.slice(1)}ing user ${userId}`);
        // In a real implementation, this would send an AJAX request
    }
}

// Delete user
function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        alert('Deleting user ' + userId);
        // In a real implementation, this would send a DELETE request
    }
}

// Initialize table sorting (simple implementation)
document.querySelectorAll('th').forEach((header, index) => {
    header.style.cursor = 'pointer';
    header.addEventListener('click', () => {
        sortTable(index);
    });
});

function sortTable(columnIndex) {
    const table = document.getElementById('usersTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.toLowerCase();
        const bText = b.cells[columnIndex].textContent.toLowerCase();
        return aText.localeCompare(bText);
    });

    rows.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}